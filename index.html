<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villa Kunterbunt KellerlÃ¼ftungsberater</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* -- Base & M3 Typography -- */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(135deg, var(--surface, #111827) 0%, color-mix(in srgb, var(--surface, #111827) 85%, var(--primary, #4caf50) 15%) 100%);
            color: var(--on-surface, #e5e7eb);
            transition: background 0.8s ease;
            min-height: 100vh;
            overflow-x: hidden;
            max-width: 100vw;
        }
        .display-small { font-size: 36px; line-height: 44px; font-weight: 400; }
        .headline-medium { font-size: 28px; line-height: 36px; font-weight: 400; }
        .title-large { font-size: 22px; line-height: 28px; font-weight: 500; }
        .label-large { font-size: 14px; line-height: 20px; font-weight: 500; }
        .body-medium { font-size: 14px; line-height: 20px; font-weight: 400; }

        /* -- Transitions -- */
        .ventilation-card, .ventilation-accent, input[type="range"]::-webkit-slider-thumb, #status-image {
            transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }

        /* -- M3 Ventilation-Based Color Palettes -- */
        .ventilation-good {
            --surface: #0f1b0f;
            --surface-container: #1a251a;
            --surface-container-high: #242f24;
            --primary: #4caf50;
            --on-primary: #ffffff;
            --on-surface: #e8f5e8;
            --on-surface-variant: #c8d6c8;
        }
        .ventilation-caution {
            --surface: #1c1a0f;
            --surface-container: #252218;
            --surface-container-high: #2f2d20;
            --primary: #ff9800;
            --on-primary: #ffffff;
            --on-surface: #f5f3e8;
            --on-surface-variant: #d6d4c8;
        }
        .ventilation-danger {
            --surface: #1c0f0f;
            --surface-container: #251a1a;
            --surface-container-high: #2f2424;
            --primary: #f44336;
            --on-primary: #ffffff;
            --on-surface: #f5e8e8;
            --on-surface-variant: #d6c8c8;
        }

        /* Subtle backdrop elements */
        .backdrop-orb {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, color-mix(in srgb, var(--primary) 15%, transparent 85%) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
            animation: float-gentle 8s ease-in-out infinite;
        }
        
        .backdrop-orb-1 {
            width: 300px;
            height: 300px;
            top: 10%;
            right: -150px;
            animation-delay: 0s;
        }
        
        .backdrop-orb-2 {
            width: 200px;
            height: 200px;
            bottom: 20%;
            left: -100px;
            animation-delay: 3s;
        }
        
        .backdrop-orb-3 {
            width: 150px;
            height: 150px;
            top: 60%;
            right: -75px;
            animation-delay: 6s;
        }
        
        @keyframes float-gentle {
            0%, 100% { transform: translateY(0px) scale(1); opacity: 0.3; }
            50% { transform: translateY(-20px) scale(1.1); opacity: 0.5; }
        }

        /* -- Organic Card Styling -- */
        .organic-card {
            border-radius: 32px 24px 32px 24px;
            backdrop-filter: blur(20px);
            background: color-mix(in srgb, var(--surface-container) 95%, transparent 5%);
            border: 2px solid color-mix(in srgb, var(--primary) 30%, transparent 70%);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 0 0 1px color-mix(in srgb, var(--primary) 20%, transparent 80%) inset;
        }
        
        .organic-card-alt {
            border-radius: 24px 32px 24px 32px;
            backdrop-filter: blur(20px);
            background: color-mix(in srgb, var(--surface-container) 95%, transparent 5%);
            border: 2px solid color-mix(in srgb, var(--primary) 30%, transparent 70%);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 0 0 1px color-mix(in srgb, var(--primary) 20%, transparent 80%) inset;
        }
        
        .organic-small {
            border-radius: 20px 16px 20px 16px;
        }

        /* -- Applying Variables -- */
        .ventilation-card { background-color: var(--surface-container); }
        .ventilation-accent { color: var(--primary); }
        .ventilation-text-secondary { color: var(--on-surface-variant); }
        #status-image { border-color: var(--primary); }

        /* -- Pulsing Animations -- */
        @keyframes pulse-gentle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        @keyframes pulse-moderate {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.08); opacity: 0.85; }
        }
        
        @keyframes pulse-urgent {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.12); opacity: 0.8; }
        }
        
        /* Apply pulsing based on ventilation status */
        .ventilation-good #status-image {
            animation: pulse-gentle 3s ease-in-out infinite;
        }
        
        .ventilation-caution #status-image {
            animation: pulse-moderate 2.5s ease-in-out infinite;
        }
        
        .ventilation-danger #status-image {
            animation: pulse-urgent 2s ease-in-out infinite;
        }
        
        /* Subtle pulsing for recommendation box */
        @keyframes card-glow-gentle {
            0%, 100% { box-shadow: 0 4px 20px rgba(76, 175, 80, 0.1); }
            50% { box-shadow: 0 4px 30px rgba(76, 175, 80, 0.2); }
        }
        
        @keyframes card-glow-caution {
            0%, 100% { box-shadow: 0 4px 20px rgba(255, 152, 0, 0.15); }
            50% { box-shadow: 0 4px 30px rgba(255, 152, 0, 0.25); }
        }
        
        @keyframes card-glow-danger {
            0%, 100% { box-shadow: 0 4px 20px rgba(244, 67, 54, 0.2); }
            50% { box-shadow: 0 4px 35px rgba(244, 67, 54, 0.3); }
        }
        
        .ventilation-good #recommendation-box {
            animation: card-glow-gentle 4s ease-in-out infinite;
        }
        
        .ventilation-caution #recommendation-box {
            animation: card-glow-caution 3s ease-in-out infinite;
        }
        
        .ventilation-danger #recommendation-box {
            animation: card-glow-danger 2.5s ease-in-out infinite;
        }
        
        /* Subtle pulsing for key metrics */
        @keyframes text-pulse-gentle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Prevent horizontal overflow */
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }
        
        .container-responsive {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        /* Responsive forecast card */
        @media (max-width: 640px) {
            .forecast-grid {
                gap: 0.5rem;
            }
            
            .forecast-card {
                margin-left: -0.5rem;
                margin-right: -0.5rem;
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .humidity-chart-mobile {
                gap: 0.125rem;
            }
            
            .time-labels-mobile {
                font-size: 0.6rem;
            }
            
            /* Ensure charts never overflow */
            #temperature-chart, #humidity-chart, #quality-zones, #time-labels {
                max-width: 100%;
                overflow: hidden;
            }
            
            /* Compress forecast window cards on mobile */
            .optimal-window-mobile {
                padding: 0.75rem;
            }
        }
        
        .ventilation-danger #final-humidity {
            animation: text-pulse-gentle 3s ease-in-out infinite;
        }
        
        /* Subtle glow effect for status image */
        #status-image {
            transition: all 0.8s ease;
            box-shadow: 
                0 0 40px rgba(var(--primary-rgb, 76, 175, 80), 0.3),
                0 20px 60px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .ventilation-good #status-image {
            box-shadow: 
                0 0 50px rgba(76, 175, 80, 0.5),
                0 20px 60px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .ventilation-caution #status-image {
            box-shadow: 
                0 0 50px rgba(255, 152, 0, 0.5),
                0 20px 60px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .ventilation-danger #status-image {
            box-shadow: 
                0 0 50px rgba(244, 67, 54, 0.5),
                0 20px 60px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        /* -- M3 Components -- */
        /* Switch */
        .switch { width: 52px; height: 32px; background-color: var(--surface-container-high); border-radius: 100px; position: relative; }
        .switch-thumb { width: 24px; height: 24px; background-color: #8e9094; border-radius: 50%; position: absolute; top: 4px; left: 4px; transition: transform 0.25s ease, background-color 0.25s ease; }
        .mode-switch:checked + .switch .switch-thumb { transform: translateX(20px); background-color: var(--on-primary); }
        .mode-switch:checked + .switch { background-color: var(--primary); }

        /* Slider */
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background-color: var(--surface-container-high); border-radius: 2px; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px; border-radius: 50%;
            background-color: var(--primary);
            border: none;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px; border-radius: 50%; cursor: pointer;
            background-color: var(--primary);
            border: none;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 relative">
    <!-- Subtle backdrop orbs -->
    <div class="backdrop-orb backdrop-orb-1"></div>
    <div class="backdrop-orb backdrop-orb-2"></div>
    <div class="backdrop-orb backdrop-orb-3"></div>

    <div class="w-full max-w-7xl mx-auto px-4 relative z-10 container-responsive" style="max-width: 100vw;">
        <header class="text-center mb-8">
            <!-- Ventilation Status Image -->
            <div id="status-image-container" class="mb-8 flex justify-center">
                <img id="status-image" src="" alt="Ventilation status" class="w-48 h-48 rounded-full object-cover border-4 shadow-2xl">
            </div>
            <h1 id="main-title" class="headline-medium ventilation-accent mb-4">Villa Kunterbunt KellerlÃ¼ftungsberater</h1>
            <p class="mt-2 body-medium ventilation-text-secondary max-w-sm mx-auto leading-relaxed">Get smart advice on when to open your windows for optimal basement ventilation.</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-6">
            <!-- Input Controls Card -->
            <div class="p-8 shadow-2xl ventilation-card organic-card">
            <!-- Mode Switch -->
            <div class="flex items-center justify-center space-x-4 mb-6">
                <span class="label-large ventilation-text-secondary">Manual</span>
                <label for="mode-switch" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="mode-switch" class="sr-only mode-switch" checked>
                    <div class="switch">
                        <div class="switch-thumb"></div>
                    </div>
                </label>
                <span class="label-large" style="color: var(--on-surface);">Auto (Live Weather)</span>
            </div>

            <!-- Auto Mode View -->
            <div id="auto-mode" class="">
                 <div class="text-center mb-4">
                    <p class="title-large" style="color: var(--on-surface);">Weather for Thun, Switzerland</p>
                    <p id="loading-message" class="body-medium ventilation-accent">Fetching live weather data...</p>
                    <!-- Persistent sample data warning -->
                    <div id="sample-data-warning" class="hidden mt-2 px-3 py-1 bg-yellow-500/20 border border-yellow-500/40 rounded-full inline-block">
                        <p class="text-sm font-medium text-yellow-200 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" x2="12" y1="9" y2="13"></line><line x1="12" x2="12.01" y1="17" y2="17"></line></svg>
                            Using Sample Data
                        </p>
                    </div>
                 </div>
                 <div id="weather-data-container" class="hidden space-y-6">
                    <div class="bg-black/20 p-4 lg:p-6 organic-small backdrop-blur-sm">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-2 md:gap-4 lg:gap-6 text-center">
                        <div>
                        <p class="text-3xl sm:text-2xl md:text-3xl lg:text-4xl font-normal" style="color: var(--on-surface);"><span id="auto-temp-out">--</span>Â°</p>
                        <p class="text-sm sm:text-xs md:text-sm lg:text-base font-medium ventilation-text-secondary">Temperature</p>
                        </div>
                        <div class="border-t sm:border-t-0 sm:border-l sm:border-r border-gray-600/30 pt-4 sm:pt-0">
                        <p class="text-3xl sm:text-2xl md:text-3xl lg:text-4xl font-normal" style="color: var(--on-surface);"><span id="auto-rh-out">--</span>%</p>
                        <p class="text-sm sm:text-xs md:text-sm lg:text-base font-medium ventilation-text-secondary">Humidity</p>
                        </div>
                        <div class="border-t sm:border-t-0 border-gray-600/30 pt-4 sm:pt-0">
                        <p class="text-3xl sm:text-2xl md:text-3xl lg:text-4xl font-normal" style="color: var(--on-surface);"><span id="auto-dewpoint-out">--</span>Â°</p>
                        <p class="text-sm sm:text-xs md:text-sm lg:text-base font-medium ventilation-text-secondary">Dew Point</p>
                        </div>
                        </div>
                    </div>
                     <div>
                        <label for="basement-temp-auto" class="block label-large text-gray-300 mb-2">Your Basement Temperature</label>
                        <div class="flex items-center space-x-4">
                            <input type="range" id="basement-temp-auto" min="0" max="30" value="20" step="0.5">
                            <span id="basement-temp-auto-value" class="font-bold text-lg w-16 text-center" style="color: var(--on-surface);">20Â°C</span>
                        </div>
                    </div>
                 </div>
            </div>
            
            <!-- Manual Mode View -->
            <div id="manual-mode" class="space-y-4 hidden">
                <div>
                    <label for="temp-in" class="block label-large text-gray-300 mb-2">Basement Temperature</label>
                    <div class="flex items-center space-x-4">
                        <input type="range" id="temp-in" min="0" max="30" value="20" step="0.5">
                        <span id="temp-in-value" class="font-bold text-lg w-16 text-center" style="color: var(--on-surface);">20Â°C</span>
                    </div>
                </div>
                <div>
                    <label for="temp-out" class="block label-large text-gray-300 mb-2">Outside Temperature</label>
                    <div class="flex items-center space-x-4">
                        <input type="range" id="temp-out" min="-10" max="35" value="15" step="0.5">
                        <span id="temp-out-value" class="font-bold text-lg w-16 text-center" style="color: var(--on-surface);">15Â°C</span>
                    </div>
                </div>
                <div>
                    <label for="rh-out" class="block label-large text-gray-300 mb-2">Outside Relative Humidity</label>
                    <div class="flex items-center space-x-4">
                        <input type="range" id="rh-out" min="20" max="100" value="89" step="1">
                        <span id="rh-out-value" class="font-bold text-lg w-16 text-center" style="color: var(--on-surface);">89%</span>
                    </div>
                </div>
            </div>
            </div>

            <!-- Enhanced Results Section -->
            <div id="results-card" class="p-8 shadow-2xl ventilation-card organic-card">
            <h2 class="title-large text-center mb-6" style="color: var(--on-surface);">Outcome</h2>
            <div class="text-center mb-6">
                <p class="label-large ventilation-text-secondary">Expected Basement Humidity</p>
                <p id="final-humidity" class="display-small ventilation-accent font-bold">--%</p>
            </div>
            <div id="recommendation-box" class="flex items-center p-6 organic-small transition-all duration-300 mb-6">
                <div id="recommendation-icon" class="mr-4"></div>
                <div>
                    <h3 id="recommendation-title" class="title-large"></h3>
                    <p id="recommendation-summary" class="body-medium"></p>
                </div>
            </div>
            
            <!-- Enhanced Dynamic Advisor -->
            <div class="border-t border-gray-600/20 pt-6">
                <div id="dynamic-advisor-container" class="flex items-start space-x-3 ventilation-text-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 mt-1"><path d="m9 12 2 2 4-4"></path><path d="M21 12c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1"></path><path d="M17 7h4a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-4"></path><path d="M7 7H3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h4"></path></svg>
                    <div class="flex-1">
                        <h4 class="label-large mb-2" style="color: var(--on-surface);">Smart Advisor</h4>
                        <p id="dynamic-advisor-text" class="body-medium leading-relaxed">Loading intelligent basement ventilation advice...</p>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Enhanced Forecast Card -->
        <div id="forecast-card" class="hidden mt-8 p-4 sm:p-8 shadow-2xl ventilation-card organic-card-alt forecast-card">
            <div class="flex items-center justify-between mb-6 flex-wrap gap-2">
                <h2 class="title-large" style="color: var(--on-surface);">ðŸ“ˆ Next 6 Hours</h2>
                <button id="toggle-forecast" class="px-3 py-1 sm:px-4 sm:py-2 bg-black/20 rounded-full text-xs sm:text-sm hover:bg-black/30 transition-colors flex-shrink-0" style="color: var(--on-surface-variant);">
                    Hide
                </button>
            </div>
            
            <!-- Forecast Loading State -->
            <div id="forecast-loading" class="text-center py-8">
                <p class="body-medium ventilation-text-secondary">Loading 6-hour forecast...</p>
            </div>
            
            <!-- Forecast Content -->
            <div id="forecast-content" class="hidden">
                <!-- Timeline Visualization -->
                <div class="mb-6 forecast-grid">
                    <div class="relative overflow-hidden">
                        <!-- Temperature Chart -->
                        <div class="mb-4">
                            <p class="text-xs sm:text-sm ventilation-text-secondary mb-2">Temperature (Â°C)</p>
                            <div class="h-16 sm:h-20 relative overflow-hidden" id="temperature-chart">
                                <!-- Temperature line will be drawn here with SVG -->
                            </div>
                        </div>
                        
                        <!-- Humidity Bars -->
                        <div class="mb-4">
                            <p class="text-xs sm:text-sm ventilation-text-secondary mb-2">Humidity (%)</p>
                            <div class="h-12 sm:h-16 relative flex items-end justify-between humidity-chart-mobile" id="humidity-chart">
                                <!-- Humidity bars will be added here -->
                            </div>
                        </div>
                        
                        <!-- Ventilation Quality Zones -->
                        <div class="mb-4">
                            <p class="text-xs sm:text-sm ventilation-text-secondary mb-2">Quality</p>
                            <div class="h-8 sm:h-12 relative flex" id="quality-zones">
                                <!-- Color-coded quality zones will be added here -->
                            </div>
                        </div>
                        
                        <!-- Time Labels -->
                        <div class="flex justify-between text-xs ventilation-text-secondary time-labels-mobile" id="time-labels">
                            <!-- Time labels will be added here -->
                        </div>
                    </div>
                </div>
                
                <!-- Optimal Windows Summary -->
                <div id="optimal-windows" class="space-y-3 sm:space-y-4">
                    <!-- Optimal window recommendations will be added here -->
                </div>
                
                <!-- Extended Forecast Fallback -->
                <div id="extended-forecast" class="hidden mt-4 sm:mt-6 p-3 sm:p-4 bg-black/20 rounded-xl">
                    <h3 class="text-sm sm:text-base font-medium mb-2 sm:mb-3" style="color: var(--on-surface);">ðŸ“… No Good Opportunities Today</h3>
                    <div id="extended-forecast-content">
                        <!-- Extended forecast content will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- DOM ELEMENTS ---
    const body = document.body;
    const modeSwitch = document.getElementById('mode-switch');
    const autoModeDiv = document.getElementById('auto-mode');
    const manualModeDiv = document.getElementById('manual-mode');
    const statusImage = document.getElementById('status-image');
    
    // Manual Inputs
    const tempInSlider = document.getElementById('temp-in');
    const tempOutSlider = document.getElementById('temp-out');
    const rhOutSlider = document.getElementById('rh-out');
    const tempInValue = document.getElementById('temp-in-value');
    const tempOutValue = document.getElementById('temp-out-value');
    const rhOutValue = document.getElementById('rh-out-value');

    // Auto Inputs & Displays
    const basementTempAutoSlider = document.getElementById('basement-temp-auto');
    const basementTempAutoValue = document.getElementById('basement-temp-auto-value');
    const autoTempOutDisplay = document.getElementById('auto-temp-out');
    const autoRhOutDisplay = document.getElementById('auto-rh-out');
    const autoDewPointDisplay = document.getElementById('auto-dewpoint-out');
    const loadingMessage = document.getElementById('loading-message');
    const weatherDataContainer = document.getElementById('weather-data-container');
    const sampleDataWarning = document.getElementById('sample-data-warning');

    // Global weather trend data
    let currentWeatherTrend = null;
    let forecastData = null;
    let optimalWindows = [];

    // Results
    const finalHumidityDisplay = document.getElementById('final-humidity');
    const mainTitle = document.getElementById('main-title');
    const recommendationBox = document.getElementById('recommendation-box');
    const recommendationIcon = document.getElementById('recommendation-icon');
    const recommendationTitle = document.getElementById('recommendation-title');
    const recommendationSummary = document.getElementById('recommendation-summary');
    
    // Dynamic Advisor (now in results card)
    const dynamicAdvisorText = document.getElementById('dynamic-advisor-text');
    const dynamicAdvisorContainer = document.getElementById('dynamic-advisor-container');
    
    // Forecast Card Elements
    const forecastCard = document.getElementById('forecast-card');
    const toggleForecastBtn = document.getElementById('toggle-forecast');
    const forecastLoading = document.getElementById('forecast-loading');
    const forecastContent = document.getElementById('forecast-content');
    const temperatureChart = document.getElementById('temperature-chart');
    const humidityChart = document.getElementById('humidity-chart');
    const qualityZones = document.getElementById('quality-zones');
    const timeLabels = document.getElementById('time-labels');
    const optimalWindowsDiv = document.getElementById('optimal-windows');
    const extendedForecast = document.getElementById('extended-forecast');
    const extendedForecastContent = document.getElementById('extended-forecast-content');

    // --- SVG ICONS ---
    const ICONS = {
        good: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>`,
        bad: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v7a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"></path></svg>`,
        warning: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" x2="12" y1="9" y2="13"></line><line x1="12" x2="12.01" y1="17" y2="17"></line></svg>`
    };

    // --- CORE LOGIC ---
    function calculateFinalHumidity(tempIn, tempOut, rhOut) {
        const calcEs = (temp) => 6.112 * Math.exp((17.67 * temp) / (temp + 243.5));
        const esOut = calcEs(tempOut);
        const eOut = esOut * (rhOut / 100);
        const esIn = calcEs(tempIn);
        const finalRh = (eOut / esIn) * 100;
        return Math.min(100, Math.round(finalRh));
    }

    function calculateDewPoint(temp, rh) {
        const a = 17.625;
        const b = 243.04;
        const alpha = Math.log(rh / 100) + (a * temp) / (b + temp);
        const dewPoint = (b * alpha) / (a - alpha);
        return dewPoint;
    }
    
    function updateUI() {
        let tempIn, tempOut, rhOut;
        updateContextualInfo(); 

        if (modeSwitch.checked) {
            tempIn = parseFloat(basementTempAutoSlider.value);
            tempOut = parseFloat(autoTempOutDisplay.textContent);
            rhOut = parseFloat(autoRhOutDisplay.textContent);
            if (isNaN(tempOut) || isNaN(rhOut)) return;
        } else {
            tempIn = parseFloat(tempInSlider.value);
            tempOut = parseFloat(tempOutSlider.value);
            rhOut = parseFloat(rhOutSlider.value);
        }

        const finalHumidity = calculateFinalHumidity(tempIn, tempOut, rhOut);
        const dewPointOut = calculateDewPoint(tempOut, rhOut);
        finalHumidityDisplay.textContent = `${finalHumidity}%`;

        let rec = {};
        let ventilationStatus = 'good'; // default
        
        if (dewPointOut >= tempIn - 1.5) {
            rec = { title: "Do Not Ventilate!", summary: `High condensation risk. The outside air is too moist (${dewPointOut.toFixed(1)}Â°C dew point).`, color: 'bg-red-500/20 text-red-300', icon: ICONS.bad };
            ventilationStatus = 'danger';
        } else if (tempOut > tempIn) {
            rec = { title: "Do Not Ventilate!", summary: `The outside air is warmer. This will heat your basement and likely add moisture.`, color: 'bg-red-500/20 text-red-300', icon: ICONS.bad };
            ventilationStatus = 'danger';
        } else if (finalHumidity < 60) {
            rec = { title: "Yes, Ventilate!", summary: `Ideal conditions. You will effectively cool and dehumidify your basement.`, color: 'bg-green-500/20 text-green-300', icon: ICONS.good };
            ventilationStatus = 'good';
        } else if (finalHumidity < 75) {
            rec = { title: "Ventilate with Caution", summary: `This will help cool, but won't significantly lower humidity. Safe from condensation.`, color: 'bg-yellow-500/20 text-yellow-300', icon: ICONS.warning };
            ventilationStatus = 'caution';
        } else {
            rec = { title: "Do Not Ventilate", summary: `This will make your basement more humid. The final humidity is too high.`, color: 'bg-red-500/20 text-red-300', icon: ICONS.bad };
            ventilationStatus = 'danger';
        }
        
        // Apply ventilation-based theme
        applyVentilationTheme(ventilationStatus);
        
        recommendationTitle.textContent = rec.title;
        recommendationSummary.textContent = rec.summary;
        recommendationBox.className = `flex items-center p-4 rounded-xl transition-all duration-300 ${rec.color}`;
        recommendationIcon.innerHTML = rec.icon;
    }

    // --- CONTEXT & DYNAMIC ADVISOR ---
    function applyVentilationTheme(ventilationStatus) {
        // Remove existing ventilation classes
        body.className = body.className.replace(/ventilation-\w+/g, '');
        
        if (ventilationStatus) {
            body.classList.add(`ventilation-${ventilationStatus}`);
            
            // Update status image based on ventilation recommendation
            const statusImages = {
                'good': './images/good.png',       // Green status icon
                'caution': './images/caution.png', // Orange/yellow status icon
                'danger': './images/danger.png'    // Red status icon
            };
            
            if (statusImages[ventilationStatus]) {
                statusImage.src = statusImages[ventilationStatus];
            } else {
                // Fallback to a neutral state
                statusImage.src = './images/good.png';
            }
        }
    }

    function getSeason(d) {
        const month = d.getMonth();
        if (month < 2 || month === 11) return 'Winter';
        if (month >= 2 && month < 5) return 'Spring';
        if (month >= 5 && month < 8) return 'Summer';
        return 'Autumn';
    }

    function updateContextualInfo() {
        const now = new Date();
        const hour = now.getHours();
        const season = getSeason(now);
        
        let hint = "General Tip: Ventilate when outside is cooler and the dew point is lower than your basement's temperature.";
        let trend = "Stable";
        
        // Use real weather trend if available (from API), otherwise fall back to time-based logic
        if (currentWeatherTrend && modeSwitch.checked) {
            trend = currentWeatherTrend;
        } else {
            // Fallback to time-based trend estimation
            if ((season === 'Summer' || season === 'Spring') && (hour > 4 && hour < 12)) {
                trend = "Rising â†—";
            } else if (hour > 17 || hour < 3) {
                trend = "Falling â†˜";
            }
        }
        
        dynamicAdvisorContainer.classList.remove('ventilation-accent');
        dynamicAdvisorText.classList.remove('font-bold');

        // Get current conditions for enhanced basement-specific advice
        let tempIn, tempOut, rhOut;
        if (modeSwitch.checked) {
            tempIn = parseFloat(basementTempAutoSlider.value);
            tempOut = parseFloat(autoTempOutDisplay.textContent);
            rhOut = parseFloat(autoRhOutDisplay.textContent);
        } else {
            tempIn = parseFloat(tempInSlider.value);
            tempOut = parseFloat(tempOutSlider.value);
            rhOut = parseFloat(rhOutSlider.value);
        }

        // Enhanced basement ventilation advice
        if (!isNaN(tempIn) && !isNaN(tempOut) && !isNaN(rhOut)) {
            const dewPointOut = calculateDewPoint(tempOut, rhOut);
            const finalHumidity = calculateFinalHumidity(tempIn, tempOut, rhOut);
            
            // High-priority warnings (dangerous conditions)
            if (dewPointOut >= tempIn - 1.5) {
                hint = `âš ï¸ High condensation risk! Outside dew point (${dewPointOut.toFixed(1)}Â°C) is too close to your basement temperature. Wait for drier conditions.`;
                dynamicAdvisorContainer.classList.add('ventilation-accent');
                dynamicAdvisorText.classList.add('font-bold');
            } 
            else if (tempOut > tempIn + 3) {
                hint = `ðŸ”¥ Outside much warmer (${tempOut.toFixed(1)}Â°C vs ${tempIn}Â°C). Ventilating will heat and significantly humidify your basement.`;
                dynamicAdvisorContainer.classList.add('ventilation-accent');
                dynamicAdvisorText.classList.add('font-bold');
            }
            else if (rhOut > 95 && tempOut > tempIn) {
                hint = `ðŸ’§ Extremely humid outside (${rhOut}%) + warmer temps = recipe for basement moisture problems. Avoid ventilation.`;
                dynamicAdvisorContainer.classList.add('ventilation-accent');
                dynamicAdvisorText.classList.add('font-bold');
            }
            // Optimal conditions (encouraging advice)
            else if (finalHumidity < 45 && tempOut < tempIn - 4) {
                hint = `âœ¨ Excellent conditions! Cool, dry air will perfectly dehumidify your basement. Ventilate for 3-4 hours maximum.`;
            }
            else if (finalHumidity < 55 && dewPointOut < tempIn - 4) {
                if (trend === "Falling â†˜" && (hour >= 20 || hour <= 6)) {
                    hint = `ðŸŒ™ Perfect timing! Night cooling + low dew point = ideal basement ventilation. Expected humidity: ${finalHumidity}%.`;
                } else {
                    hint = `ðŸ‘ Great conditions! Ventilation will achieve ${finalHumidity}% humidity - perfect for preventing mold in basements.`;
                }
            }
            // Good conditions with specific guidance
            else if (finalHumidity < 65 && tempOut < tempIn - 1) {
                if (season === 'Winter' && tempOut < 5) {
                    hint = `â„ï¸ Winter advantage: Cold air = dry air! Brief 1-2 hour sessions dehumidify effectively. Monitor heating costs.`;
                } else if (trend === "Falling â†˜") {
                    hint = `ðŸ“‰ Good timing! Falling temperatures favor basement ventilation. Target humidity: ${finalHumidity}%.`;
                } else {
                    hint = `âœ… Solid conditions. Ventilation will cool and moderately dehumidify (${finalHumidity}%). Safe from condensation.`;
                }
            }
            // Marginal conditions
            else if (finalHumidity < 75 && dewPointOut < tempIn - 2) {
                hint = `âš ï¸ Marginal benefit. Ventilation cools but won't dramatically reduce humidity (${finalHumidity}%). Monitor closely.`;
            }
            // Poor conditions
            else if (finalHumidity >= 75) {
                hint = `âŒ Not recommended. Would result in ${finalHumidity}% humidity - too high for basements, promotes mold growth.`;
            }
            // Time-specific optimizations
            else if (season === 'Summer' && trend === "Rising â†—" && hour >= 6 && hour <= 10 && tempOut < tempIn) {
                hint = `â˜€ï¸ Summer morning: Temperatures rising. If you ventilate, close windows by 10 AM to avoid heat trapping.`;
                dynamicAdvisorContainer.classList.add('ventilation-accent');
            }
            else if ((hour >= 22 || hour <= 5) && tempOut < tempIn && rhOut < 80) {
                hint = `ðŸŒœ Night ventilation: Often optimal for basements. Coolest temps, lower humidity. Monitor dew point closely.`;
            }
        }
        // Seasonal fallbacks when specific conditions aren't available
        else {
            if (season === 'Winter') {
                hint = "â„ï¸ Winter strategy: Cold air holds less moisture. Short ventilation bursts (1-2 hours) effectively dry basements.";
            } else if (season === 'Summer') {
                hint = "â˜€ï¸ Summer tip: Best basement ventilation windows are late evening through early morning when coolest.";
            } else if (season === 'Spring') {
                hint = "ðŸŒ¸ Spring opportunity: Mild, variable weather. Watch for sudden humidity/temperature swings during transitions.";
            } else {
                hint = "ðŸ‚ Autumn advantage: Cooling temperatures excellent for basement ventilation. Watch humidity during rainy periods.";
            }
        }
        
        dynamicAdvisorText.textContent = hint;
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        [tempInSlider, tempOutSlider, rhOutSlider].forEach(slider => {
            slider.addEventListener('input', () => {
                tempInValue.textContent = `${tempInSlider.value}Â°C`;
                tempOutValue.textContent = `${tempOutSlider.value}Â°C`;
                rhOutValue.textContent = `${rhOutSlider.value}%`;
                updateUI();
            });
        });

        basementTempAutoSlider.addEventListener('input', () => {
             basementTempAutoValue.textContent = `${basementTempAutoSlider.value}Â°C`;
             updateUI();
             if (forecastData) {
                 updateForecastAnalysis();
             }
        });
        
        toggleForecastBtn.addEventListener('click', () => {
            forecastCard.classList.add('hidden');
        });

        modeSwitch.addEventListener('change', () => {
            if (modeSwitch.checked) {
                autoModeDiv.classList.remove('hidden');
                manualModeDiv.classList.add('hidden');
                fetchWeatherData();
            } else {
                autoModeDiv.classList.add('hidden');
                manualModeDiv.classList.remove('hidden');
                currentWeatherTrend = null; // Clear weather trend when switching to manual
                sampleDataWarning.classList.add('hidden'); // Hide sample data warning in manual mode
                forecastCard.classList.add('hidden'); // Hide forecast card in manual mode
                updateUI();
            }
        });
        
        // Handle window resize to update charts responsively
        window.addEventListener('resize', () => {
            if (forecastData && !forecastCard.classList.contains('hidden')) {
                updateForecastCard();
            }
        });
    }

    // --- API & AUTO MODE LOGIC ---
    async function fetchWeatherData() {
        loadingMessage.classList.remove('hidden');
        loadingMessage.textContent = 'Fetching live weather data from Open-Meteo...';
        weatherDataContainer.classList.add('hidden');

        // Thun, Switzerland coordinates
        const latitude = 46.7578;
        const longitude = 7.6274;
        
        try {
            // Enhanced Open-Meteo API call - get current weather AND 6-hour detailed forecast
            const response = await fetch(
                `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,dewpoint_2m&hourly=temperature_2m,relative_humidity_2m,dewpoint_2m&forecast_hours=6&timezone=Europe/Berlin`
            );
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const weatherData = await response.json();
            
            // Extract current weather data
            const temperature = weatherData.current.temperature_2m;
            const humidity = weatherData.current.relative_humidity_2m;
            const dewPoint = weatherData.current.dewpoint_2m;
            
            // Calculate temperature trend from hourly forecast
            const hourlyTemps = weatherData.hourly.temperature_2m;
            let trend = "Stable";
            if (hourlyTemps && hourlyTemps.length >= 3) {
                const currentTemp = hourlyTemps[0];
                const temp3h = hourlyTemps[2];
                const tempDiff = temp3h - currentTemp;
                
                if (tempDiff > 1) {
                    trend = "Rising â†—";
                } else if (tempDiff < -1) {
                    trend = "Falling â†˜";
                } else {
                    trend = "Stable";
                }
            }
            currentWeatherTrend = trend;
            
            // Update displays with real data
            autoTempOutDisplay.textContent = temperature.toFixed(1);
            autoRhOutDisplay.textContent = humidity;
            autoDewPointDisplay.textContent = dewPoint.toFixed(1);
            
            // Show success message briefly
            loadingMessage.textContent = `âœ“ Live data from Thun (${new Date().toLocaleTimeString()})`;
            sampleDataWarning.classList.add('hidden'); // Hide sample data warning
            setTimeout(() => {
                loadingMessage.classList.add('hidden');
            }, 2000);
            
            weatherDataContainer.classList.remove('hidden');
            
            // Process forecast data for the forecast card
            await processForecastData(weatherData);
            
            updateUI();
            
        } catch (error) {
            console.error('Weather API Error:', error);
            
            // Fallback to mock data if API fails
            autoTempOutDisplay.textContent = '16.5';
            autoRhOutDisplay.textContent = '85';
            autoDewPointDisplay.textContent = '14.2';
            currentWeatherTrend = null; // No trend data available in fallback
            loadingMessage.textContent = 'âš ï¸ Using sample data (API unavailable)';
            sampleDataWarning.classList.remove('hidden'); // Show persistent warning
            
            setTimeout(() => {
                loadingMessage.classList.add('hidden');
            }, 3000);
            
            weatherDataContainer.classList.remove('hidden');
            
            // Create mock forecast data for the forecast card when API fails
            await createMockForecastData();
            
            updateUI();
        }
    }

    // --- INITIALIZATION ---
    function initialize() {
        setupEventListeners();
        applyVentilationTheme('good'); // Start with a default theme
        
        // Since auto mode is default, fetch weather data on startup
        if (modeSwitch.checked) {
            fetchWeatherData();
        }
        
        updateUI(); 
        setInterval(updateContextualInfo, 60000); 
    }

    // --- FORECAST CARD LOGIC ---
    
    async function processForecastData(weatherData) {
        const hourlyData = weatherData.hourly;
        const currentBasementTemp = parseFloat(basementTempAutoSlider.value);
        
        forecastData = {
            hours: [],
            optimalWindows: []
        };
        
        // Process each hour of forecast data
        for (let i = 0; i < hourlyData.time.length; i++) {
            const temp = hourlyData.temperature_2m[i];
            const humidity = hourlyData.relative_humidity_2m[i];
            const dewPoint = hourlyData.dewpoint_2m[i];
            
            // Calculate ventilation metrics for this hour
            const finalHumidity = calculateFinalHumidity(currentBasementTemp, temp, humidity);
            const ventilationScore = calculateVentilationScore(currentBasementTemp, temp, humidity, dewPoint, finalHumidity);
            const recommendation = getVentilationRecommendation(ventilationScore, finalHumidity, dewPoint, currentBasementTemp);
            
            forecastData.hours.push({
                time: hourlyData.time[i],
                temperature: temp,
                humidity: humidity,
                dewPoint: dewPoint,
                finalHumidity: finalHumidity,
                ventilationScore: ventilationScore,
                recommendation: recommendation
            });
        }
        
        // Find optimal ventilation windows
        forecastData.optimalWindows = findOptimalWindows(forecastData.hours, currentBasementTemp);
        
        // Show forecast card and update UI
        updateForecastCard();
        forecastCard.classList.remove('hidden');
    }
    
    async function createMockForecastData() {
        const currentBasementTemp = parseFloat(basementTempAutoSlider.value);
        const now = new Date();
        
        forecastData = {
            hours: [],
            optimalWindows: []
        };
        
        // Create mock 6-hour forecast data
        const baseTemp = 16.5;
        const baseHumidity = 85;
        
        for (let i = 0; i < 6; i++) {
            const futureTime = new Date(now.getTime() + i * 60 * 60 * 1000);
            // Simulate temperature dropping and humidity varying
            const temp = baseTemp - (i * 1.2) + (Math.sin(i * 0.5) * 2);
            const humidity = baseHumidity - (i * 3) + (Math.cos(i * 0.7) * 5);
            const dewPoint = calculateDewPoint(temp, humidity);
            const finalHumidity = calculateFinalHumidity(currentBasementTemp, temp, humidity);
            const ventilationScore = calculateVentilationScore(currentBasementTemp, temp, humidity, dewPoint, finalHumidity);
            const recommendation = getVentilationRecommendation(ventilationScore, finalHumidity, dewPoint, currentBasementTemp);
            
            forecastData.hours.push({
                time: futureTime.toISOString(),
                temperature: Math.round(temp * 10) / 10,
                humidity: Math.round(humidity),
                dewPoint: Math.round(dewPoint * 10) / 10,
                finalHumidity: finalHumidity,
                ventilationScore: ventilationScore,
                recommendation: recommendation
            });
        }
        
        // Find optimal windows in mock data
        forecastData.optimalWindows = findOptimalWindows(forecastData.hours, currentBasementTemp);
        
        // Show forecast card and update UI
        updateForecastCard();
        forecastCard.classList.remove('hidden');
    }
    
    function calculateVentilationScore(basementTemp, outsideTemp, outsideHumidity, dewPoint, finalHumidity) {
        let score = 0;
        
        // Condensation safety (most important factor)
        const dewPointMargin = basementTemp - dewPoint;
        if (dewPointMargin >= 3) {
            score += 40; // Excellent safety margin
        } else if (dewPointMargin >= 1.5) {
            score += 25; // Good safety margin
        } else if (dewPointMargin >= 0.5) {
            score += 10; // Minimal safety margin
        } else {
            return 0; // Unsafe - no ventilation
        }
        
        // Temperature benefit
        const tempDiff = basementTemp - outsideTemp;
        if (tempDiff >= 5) {
            score += 30; // Excellent cooling
        } else if (tempDiff >= 2) {
            score += 20; // Good cooling
        } else if (tempDiff >= 0) {
            score += 10; // Some cooling
        } else {
            score -= 20; // Will heat basement
        }
        
        // Humidity result
        if (finalHumidity <= 50) {
            score += 30; // Excellent dehumidification
        } else if (finalHumidity <= 60) {
            score += 20; // Good dehumidification
        } else if (finalHumidity <= 70) {
            score += 10; // Moderate benefit
        } else if (finalHumidity <= 75) {
            score += 5; // Minimal benefit
        } else {
            score -= 10; // Makes it more humid
        }
        
        return Math.max(0, Math.min(100, score));
    }
    
    function getVentilationRecommendation(score, finalHumidity, dewPoint, basementTemp) {
        if (dewPoint >= basementTemp - 1.5) {
            return 'dangerous';
        } else if (score >= 80) {
            return 'excellent';
        } else if (score >= 60) {
            return 'good';
        } else if (score >= 40) {
            return 'marginal';
        } else {
            return 'poor';
        }
    }
    
    function findOptimalWindows(hours, basementTemp) {
        const windows = [];
        let currentWindow = null;
        
        for (let i = 0; i < hours.length; i++) {
            const hour = hours[i];
            const isGoodForVentilation = hour.recommendation === 'excellent' || hour.recommendation === 'good';
            
            if (isGoodForVentilation) {
                if (!currentWindow) {
                    // Start new window
                    currentWindow = {
                        startTime: hour.time,
                        startIndex: i,
                        endTime: hour.time,
                        endIndex: i,
                        avgScore: hour.ventilationScore,
                        avgFinalHumidity: hour.finalHumidity,
                        minTemp: hour.temperature,
                        maxTemp: hour.temperature
                    };
                } else {
                    // Extend current window
                    currentWindow.endTime = hour.time;
                    currentWindow.endIndex = i;
                    currentWindow.avgScore = (currentWindow.avgScore + hour.ventilationScore) / 2;
                    currentWindow.avgFinalHumidity = Math.round((currentWindow.avgFinalHumidity + hour.finalHumidity) / 2);
                    currentWindow.minTemp = Math.min(currentWindow.minTemp, hour.temperature);
                    currentWindow.maxTemp = Math.max(currentWindow.maxTemp, hour.temperature);
                }
            } else {
                if (currentWindow) {
                    // Close current window and add to results
                    const duration = currentWindow.endIndex - currentWindow.startIndex + 1;
                    currentWindow.duration = duration;
                    currentWindow.quality = currentWindow.avgScore >= 80 ? 'excellent' : 'good';
                    windows.push(currentWindow);
                    currentWindow = null;
                }
            }
        }
        
        // Close any remaining window
        if (currentWindow) {
            const duration = currentWindow.endIndex - currentWindow.startIndex + 1;
            currentWindow.duration = duration;
            currentWindow.quality = currentWindow.avgScore >= 80 ? 'excellent' : 'good';
            windows.push(currentWindow);
        }
        
        return windows;
    }
    
    function updateForecastCard() {
        if (!forecastData) return;
        
        forecastLoading.classList.add('hidden');
        forecastContent.classList.remove('hidden');
        
        // Update charts with a slight delay to ensure proper sizing
        setTimeout(() => {
            updateTemperatureChart();
            updateHumidityChart();
            updateQualityZones();
            updateTimeLabels();
            updateOptimalWindows();
        }, 100);
    }
    
    function updateTemperatureChart() {
        const temps = forecastData.hours.map(h => h.temperature);
        const minTemp = Math.min(...temps) - 1;
        const maxTemp = Math.max(...temps) + 1;
        const tempRange = maxTemp - minTemp;
        
        // Wait for next frame to ensure container is properly sized
        requestAnimationFrame(() => {
            // Get accurate container width, ensuring it doesn't exceed screen width
            const containerRect = temperatureChart.getBoundingClientRect();
            const screenPadding = window.innerWidth < 640 ? 32 : 64; // Less padding on mobile
            const maxWidth = Math.min(window.innerWidth - screenPadding, containerRect.width);
            const width = Math.max(window.innerWidth < 640 ? 250 : 300, Math.min(maxWidth, containerRect.width || 350));
            const height = window.innerWidth < 640 ? 56 : 80; // More compact on mobile
            
            // Create SVG for temperature line
            let svgPath = '';
            const effectiveWidth = width - 40; // Leave margin for labels
            
            for (let i = 0; i < temps.length; i++) {
                const x = 20 + (i / (temps.length - 1)) * effectiveWidth; // 20px left margin
                const y = height - 20 - ((temps[i] - minTemp) / tempRange) * (height - 40); // 20px top/bottom margins
                
                if (i === 0) {
                    svgPath += `M ${x} ${y}`;
                } else {
                    svgPath += ` L ${x} ${y}`;
                }
            }
            
            temperatureChart.innerHTML = `
                <svg width="${width}" height="${height}" class="w-full h-full" style="max-width: 100%;" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <linearGradient id="tempGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:var(--primary);stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:var(--primary);stop-opacity:0.1" />
                        </linearGradient>
                    </defs>
                    <path d="${svgPath} L ${20 + effectiveWidth} ${height - 20} L 20 ${height - 20} Z" fill="url(#tempGradient)" />
                    <path d="${svgPath}" stroke="var(--primary)" stroke-width="2" fill="none" />
                    ${temps.map((temp, i) => {
                        const x = 20 + (i / (temps.length - 1)) * effectiveWidth;
                        const y = height - 20 - ((temp - minTemp) / tempRange) * (height - 40);
                        return `<circle cx="${x}" cy="${y}" r="${window.innerWidth < 640 ? '2' : '3'}" fill="var(--primary)" />`;
                    }).join('')}
                </svg>
                <div class="absolute top-1 left-1 text-xs" style="color: var(--on-surface-variant);">${maxTemp.toFixed(1)}Â°</div>
                <div class="absolute bottom-1 left-1 text-xs" style="color: var(--on-surface-variant);">${minTemp.toFixed(1)}Â°</div>
            `;
        });
    }
    
    function updateHumidityChart() {
        const humidities = forecastData.hours.map(h => h.humidity);
        const maxHumidity = Math.max(...humidities);
        const isMobile = window.innerWidth < 640;
        const chartHeight = isMobile ? 48 : 64; // Responsive height
        
        humidityChart.innerHTML = humidities.map((humidity, i) => {
            const height = (humidity / maxHumidity) * chartHeight;
            const color = humidity > 85 ? '#f44336' : humidity > 70 ? '#ff9800' : '#4caf50';
            const barWidth = isMobile ? 'w-6' : 'w-8';
            const fontSize = isMobile ? 'text-xs' : 'text-xs';
            
            return `
                <div class="flex flex-col items-center flex-1 min-w-0"> 
                    <div class="${barWidth} rounded-t mx-auto" style="height: ${height}px; background-color: ${color}; opacity: 0.7; max-width: 100%;"></div>
                    <span class="${fontSize} mt-1 truncate" style="color: var(--on-surface-variant);">${humidity}%</span>
                </div>
            `;
        }).join('');
    }
    
    function updateQualityZones() {
        qualityZones.innerHTML = forecastData.hours.map((hour, i) => {
            let bgColor = '#4caf50'; // green for good
            let opacity = '0.3';
            
            switch(hour.recommendation) {
                case 'excellent':
                    bgColor = '#4caf50';
                    opacity = '0.8';
                    break;
                case 'good':
                    bgColor = '#4caf50';
                    opacity = '0.5';
                    break;
                case 'marginal':
                    bgColor = '#ff9800';
                    opacity = '0.4';
                    break;
                case 'poor':
                case 'dangerous':
                    bgColor = '#f44336';
                    opacity = '0.6';
                    break;
            }
            
            return `<div class="flex-1 h-full" style="background-color: ${bgColor}; opacity: ${opacity}; margin-right: ${i < forecastData.hours.length - 1 ? '1px' : '0'};"></div>`;
        }).join('');
    }
    
    function updateTimeLabels() {
        timeLabels.innerHTML = forecastData.hours.map(hour => {
            const time = new Date(hour.time);
            return `<span>${time.getHours()}:00</span>`;
        }).join('');
    }
    
    function updateOptimalWindows() {
        if (forecastData.optimalWindows.length === 0) {
            optimalWindowsDiv.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-sm sm:body-medium ventilation-text-secondary">âŒ No optimal ventilation windows in the next 6 hours</p>
                </div>
            `;
            // TODO: Show extended forecast fallback
            return;
        }
        
        const isMobile = window.innerWidth < 640;
        
        optimalWindowsDiv.innerHTML = forecastData.optimalWindows.map(window => {
            const startTime = new Date(window.startTime);
            const endTime = new Date(window.endTime);
            const qualityIcon = window.quality === 'excellent' ? 'ðŸŒŸ' : 'ðŸ‘';
            const qualityColor = window.quality === 'excellent' ? 'text-green-300' : 'text-green-400';
            
            return `
                <div class="${isMobile ? 'optimal-window-mobile' : 'p-4'} bg-green-500/10 border border-green-500/30 rounded-xl overflow-hidden">
                    <div class="flex items-start sm:items-center justify-between mb-2 gap-2 ${isMobile ? 'flex-col' : ''}">
                        <h4 class="font-semibold ${qualityColor} flex items-center gap-2 text-sm sm:text-base min-w-0">
                            <span class="flex-shrink-0">${qualityIcon}</span>
                            <span class="truncate">${window.quality === 'excellent' ? 'Perfect' : 'Good'} Window</span>
                        </h4>
                        <span class="text-xs sm:text-sm flex-shrink-0" style="color: var(--on-surface-variant);">Score: ${Math.round(window.avgScore)}/100</span>
                    </div>
                    <p class="text-sm sm:body-medium mb-2" style="color: var(--on-surface);">
                        <strong>${startTime.getHours()}:00 - ${endTime.getHours()}:00</strong> 
                        (${window.duration} hour${window.duration > 1 ? 's' : ''})
                    </p>
                    <p class="text-xs sm:text-sm" style="color: var(--on-surface-variant);">
                        Expected humidity: <strong>${window.avgFinalHumidity}%</strong><br>
                        Temp: ${window.minTemp.toFixed(1)}Â°C - ${window.maxTemp.toFixed(1)}Â°C
                    </p>
                </div>
            `;
        }).join('');
    }
    
    function updateForecastAnalysis() {
        if (forecastData) {
            // Recalculate forecast analysis with new basement temperature
            const newBasementTemp = parseFloat(basementTempAutoSlider.value);
            
            // Update all hours with new calculations
            forecastData.hours.forEach(hour => {
                hour.finalHumidity = calculateFinalHumidity(newBasementTemp, hour.temperature, hour.humidity);
                hour.ventilationScore = calculateVentilationScore(newBasementTemp, hour.temperature, hour.humidity, hour.dewPoint, hour.finalHumidity);
                hour.recommendation = getVentilationRecommendation(hour.ventilationScore, hour.finalHumidity, hour.dewPoint, newBasementTemp);
            });
            
            // Recalculate optimal windows
            forecastData.optimalWindows = findOptimalWindows(forecastData.hours, newBasementTemp);
            
            // Update the forecast card display
            updateForecastCard();
        }
    }

    initialize();
</script>

</body>
</html>

